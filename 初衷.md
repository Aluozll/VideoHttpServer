# 关于视频web服务的初衷

家里有一台PC Windows 10系统，一直被当家庭服务器用。很多年前我在上面搭了个FTP服务，然后方便在电视盒或手机上远程观看视频。

但最近一段时间，不知什么原因，用小米播放器观看时老是掉线，用ES自带的播放器倒是没掉线问题，但是偶尔会卡顿，用户体验不好，有点不爽。
于是乎，就有了在PC上搭建一个视频web站点的念头。

## 第一次尝试

搭建资源共享的web服务很简单。第一时间，我想到了用Python的SimpleHTTPServer来实现。SimpleHTTPServer可将当前目录下的所有文件发布到web server上，
从而实现文件共享的目的。在以前的工作中，也曾经常用它来同步文件。

在Python3里，SimpleHTTPServer被整合到http.server中了，用起来也很方便。安装Python3后，直接在Windows的cmd命令行输入：

```
python http.server 8080
```
然后在浏览器输入：
```
http://127.0.0.1:8080
```
即可在浏览器看到目标目录下的所有文件。

整个安装部署过程不到5分钟就完成了，通过手机的浏览器测试，可以显示所有的视频，但在打开视频时，却出错了，视频无法播放。

起初，我以为是MP4格式的视频不支持视频流的缘故，还通过qtfaststart做了一次视频流格式化，结果还是播放失败。

然后，查看了下SimpleHTTPServer的源码，找到了原因。原来，它里面的文件链接请求都是直接通过copyfile来实现的，
一个视频1个多G呢，难怪失败了。
```
   def copyfile(self, source, outputfile):
        """Copy all data between two file objects.

        The SOURCE argument is a file object open for reading
        (or anything with a read() method) and the DESTINATION
        argument is a file object open for writing (or
        anything with a write() method).

        The only reason for overriding this would be to change
        the block size or perhaps to replace newlines by CRLF
        -- note however that this the default server uses this
        to copy binary data as well.

        """
				# 直接拷贝文件，一个视频1个多GB呢，
        shutil.copyfileobj(source, outputfile)
```

## 第二次尝试

看来想当然的方案往往是不够成熟的。接受了前面的教训，进下心来用Google大法看了些人民群众的实现方案。群众们纷纷表示用nginx来做视频流服务器最简单方便了。

在nginx.conf里开启autoindex，功能和SimpleHTTPServer类似也是将当前目录下的所有文件发布到web server上，但它支持视频播放。
```
        location /{
            #root   html;
            root D:/Temp;
            index  index.html index.htm;
            #charset utf-8;
            autoindex on;
            #autoindex_exact_size on;
            #autoindex_localtime on;
        }
```
配置好后，启动nginx服务后，浏览器上打开http://127.0.0.1:8080， 点开一个视频，瞬间播放成功！

整个部署过程不都三分钟，方案非常完美。


但，但在播放第二个视频的时候，它又又出错了。反复重试了几次后，验证了，“这个方案不能播放有中文名称的视频！”。
WK，nginx还不支持中文路径？。查看error.log，证实的确在转码的时候出错了。
```
	failed (1113: No mapping for the Unicode character exists in the target multi-byte code page)
```

在网上搜索解决方案，发现也有很多人在Windows平台上遇到了类似的问题，解决问题方案也有，那就是将中文改为英文。
显然，这个解决方案对我不受用，90%以上的视频都是中文名不说，真全英文对我来说也不利于浏览和查找了。

还好nginx是开源的，可以翻翻源码，看看能不能找出其他的解决方案。nginx/src/os/win32/的



